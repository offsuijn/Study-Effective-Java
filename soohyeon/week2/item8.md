# ì•„ì´í…œ 8 Finalizerì™€ CleanerëŠ” í”¼í•˜ë¼

**FinalizerëŠ” ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•˜ê³ , ìœ„í—˜í•˜ë©°, ëŒ€ë¶€ë¶„ ë¶ˆí•„ìš”í•˜ë‹¤.** ì´ìƒí•˜ê²Œ ë™ì‘í•˜ê¸°ë„ í•˜ê³ , ì„±ëŠ¥ë„ ì•ˆì¢‹ì•„ì§€ê³ , ì´ì‹ì„±ì—ë„ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤. Finalizerë¥¼ ìœ ìš©í•˜ê²Œ ì“¸ ìˆ˜ ìˆëŠ” ê²½ìš°ëŠ” ê·¹íˆ ë“œë¬¼ë‹¤.

ì¼ë‹¨ ìë°” 9ì—ì„œëŠ” Finalizerê°€ deprecated ëìœ¼ë©´ `Cleaner`ë¼ëŠ”ê²Œ ìƒˆë¡œ ìƒê²¨ì„œ Finalizer ë³´ë‹¤ ëœ ìœ„í—˜í•˜ì§€ë§Œ(ë³„ë„ì˜ ì“°ë ˆë“œë¥¼ ì‚¬ìš©í•˜ë‹ˆê¹Œ), **ì—¬ì „íˆ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•˜ë©°, ëŠë¦¬ê³ , ì¼ë°˜ì ìœ¼ë¡œ ë¶ˆí•„ìš”í•˜ë‹¤.**

C++ì—ì„œì˜ destructorë‘ì€ ë‹¤ë¥¸ê±°ë‹¤. C++ì˜ destructorëŠ” ì–´ë–¤ ê°ì²´ì™€ ì—°ê´€ì´ëŠ” ìì›ì„ ë°˜ë‚©í•  ë•Œë„ ì‚¬ìš©í•˜ì§€ë§Œ, ìë°”ì—ì„œëŠ” `try-with-resources`ë˜ëŠ” `try-finally` ë¸”ëŸ­ì´ ê·¸ ì—­í• ì„ í•œë‹¤.

## ë‹¨ì  1 ì–¸ì œ ì‹¤í–‰ë˜ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ë‹¤

ì–¸ì œ ì‹¤í–‰ë ì§€ ì•Œ ìˆ˜ ì—†ë‹¤. ì–´ë–¤ ê°ì²´ê°€ ë”ì´ìƒ í•„ìš” ì—†ì–´ì§„ ì‹œì ì— ê·¸ ì¦‰ì‹œ finalizer ë˜ëŠ” cleanerê°€ ë°”ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤. ê·¸ ì‚¬ì´ì— ì‹œê°„ì´ ì–¼ë§ˆë‚˜ ê±¸ë¦´ì§€ëŠ” ì•„ë¬´ë„ ëª¨ë¥¸ë‹¤. ë”°ë¼ì„œ **íƒ€ì´ë°ì´ ì¤‘ìš”í•œ ì‘ì—…ì„ ì ˆëŒ€ë¡œ finalizerë‚˜ cleanerì—ì„œ í•˜ë©´ ì•ˆëœë‹¤.** ì˜ˆë¥¼ ë“¤ì–´, íŒŒì¼ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜ë‚©í•˜ëŠ” ì‘ì—…ì„ ê·¸ ì•ˆì—ì„œ ì²˜ë¦¬í•œë‹¤ë©´, ì‹¤ì œë¡œ ê·¸ íŒŒì¼ ë¦¬ì†ŒìŠ¤ ì²˜ë¦¬ê°€ ì–¸ì œ ë ì§€ ì•Œ ìˆ˜ ì—†ê³ , ìì› ë°˜ë‚©ì´ ì•ˆë˜ì„œ ë”ì´ìƒ ìƒˆë¡œìš´ íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ëŠ” ìƒí™©ì´ ë°œìƒí•  ìˆ˜ë„ ìˆë‹¤. (ì™œëƒë©´ ì‹œìŠ¤í…œì´ ë™ì‹œì— ì—´ ìˆ˜ ìˆëŠ” íŒŒì¼ ê°œìˆ˜ì— í•œê³„ê°€ ìˆê¸° ë•Œë¬¸!)

## ë‹¨ì  2 ì¸ìŠ¤í„´ìŠ¤ ë°˜ë‚©ì„ ì§€ì—°ì‹œí‚¨ë‹¤

íŠ¹íˆ FinalizerëŠ” ì¸ìŠ¤í„´ìŠ¤ ë°˜ë‚©ì„ ì§€ì—° ì‹œí‚¬ ìˆ˜ë„ ìˆë‹¤. Finalizer ì“°ë ˆë“œëŠ” ìš°ì„  ìˆœìœ„ê°€ ë‚®ì•„ì„œ ì–¸ì œ ì‹¤í–‰ë ì§€ ëª¨ë¥¸ë‹¤. ë”°ë¼ì„œ, Finalizer ì•ˆì— ì–´ë–¤ ì‘ì—…ì´ ìˆê³ , ê·¸ ì‘ì—…ì„ ì“°ë ˆë“œê°€ ì²˜ë¦¬ ëª»í•´ì„œ ëŒ€ê¸°í•˜ê³  ìˆë‹¤ë©´, í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ëŠ” GCê°€ ë˜ì§€ ì•Šê³  ê³„ì† ìŒ“ì´ë‹¤ê°€ ê²°êµ­ì—” OutOfMomoryExceptionì´ ë°œìƒí•  ìˆ˜ë„ ìˆë‹¤.

CleanerëŠ” ë³„ë„ì˜ ì“°ë ˆë“œë¡œ ë™ì‘í•˜ë‹ˆê¹Œ ì´ ë¶€ë¶„ì— ìˆì–´ì„œ ì¡°ê¸ˆì€ ë‚˜ì„ ìˆ˜ë„ ìˆì§€ë§Œ (í•´ë‹¹ ì“°ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë†’ê²Œ ì¤€ë”ê±°ë‚˜..), ì—¬ì „íˆ í•´ë‹¹ ì“°ë ˆë“œëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë™ì‘í•˜ê³  ì–¸ì œ ì²˜ë¦¬ë ì§€ëŠ” ì•Œ ìˆ˜ ì—†ë‹¤.

## ë‹¨ì  3 ì•„ì˜ˆ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤

ì¦‰ì‹œ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ë‹¤ëŠ”ê±´ ì°¨ì¹˜í•˜ê³  Finalizerë‚˜ CleanerëŠ” ì•„ì˜ˆ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤. ë”°ë¼ì„œ, **Finalizerë‚˜ Cleanerë¡œ ì €ì¥ì†Œ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ì¼(ìƒíƒœë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ìˆ˜ì •í•˜ëŠ” ì‘ì—…)ì„ í•˜ì§€ ë§ë¼.** ë°ì´í„°ë² ì´ìŠ¤ ê°™ì€ ìì›ì˜ ë½ì„ ê·¸ê²ƒë“¤ë¡œ ë°˜í™˜í•˜ëŠ” ì‘ì—…ì„ í•œë‹¤ë©´ ì „ì²´ ë¶„ì‚° ì‹œìŠ¤í…œì´ ë©ˆì¶° ë²„ë¦´ ìˆ˜ë„ ìˆë‹¤.

`System.gc`ë‚˜ `System.runFinalization`ì— ì†ì§€ ë§ë¼. ê·¸ê±¸ ì‹¤í–‰í•´ë„ Finalizerë‚˜ Cleanerë¥¼ ë°”ë¡œ ì‹¤í–‰í•œë‹¤ê³  ë³´ì¥í•˜ì§„ ëª»í•œë‹¤. ê·¸ê±¸ ë³´ì¥í•´ì£¼ê² ë‹¤ê³  ë§Œë“  `ystem.runFinalizersOnExit`ì™€ ê·¸ ìŒë‘¥ì´ `Runtime.runFinalizersOnExit`ì€ ë‘˜ë‹¤ ë§í–ˆê³  ìˆ˜ì‹­ë…„ê°„ deprecated ìƒíƒœë‹¤.

## ë‹¨ì  4 ë–¨ì–´ì§€ëŠ” ì„±ëŠ¥ ë¬¸ì œ

ì‹¬ê°í•œ ì„±ëŠ¥ ë¬¸ì œë„ ìˆë‹¤. `AutoCloseable` ê°ì²´ë¥¼ ë§Œë“¤ê³ , `try-with-resource`ë¡œ ìì› ë°˜ë‚©ì„ í•˜ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì€ 12ns ì¸ë° ë°˜í•´, Finalizerë¥¼ ì‚¬ìš©í•œ ê²½ìš°ì— 550nsê°€ ê±¸ë ¸ë‹¤. ì•½ 50ë°°ê°€ ê±¸ë ¸ë‹¤. Cleanerë¥¼ ì‚¬ìš©í•œ ê²½ìš°ì—ëŠ” 66nsê°€ ê±¸ë ¸ë‹¤ ì•½ 5ë°°.

## ë‹¨ì  5 ì‹¬ê°í•œ *ë³´ì•ˆ ì´ìŠˆ*

Finalizer ê³µê²©ì´ë¼ëŠ” ì‹¬ê°í•œ ë³´ì•ˆ ì´ìŠˆì—ë„ ì´ìš©ë  ìˆ˜ ìˆë‹¤. ì–´ë–¤ í´ë˜ìŠ¤ê°€ ìˆê³  ê·¸ í´ë˜ìŠ¤ë¥¼ ê³µê²©í•˜ë ¤ëŠ” í´ë˜ìŠ¤ê°€ í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ëŠ”ë‹¤. ê·¸ë¦¬ê³  ê·¸ ë‚˜ìœ í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ë„ì¤‘ì— ì˜ˆì™¸ê°€ ë°œìƒí•˜ê±°ë‚˜, ì§ë ¬í™” í•  ë•Œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´, ì›ë˜ëŠ” ì£½ì—ˆì–´ì•¼ í•  ê°ì²´ì˜ finalizerê°€ ì‹¤í–‰ë  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¼ ê·¸ ì•ˆì—ì„œ í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ì˜ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ê¸°ë¡í•  ìˆ˜ë„ ìˆê³ , GCê°€ ë˜ì§€ ëª»í•˜ê²Œ í•  ìˆ˜ë„ ìˆë‹¤. ë˜í•œ ê·¸ ì•ˆì—ì„œ ì¸ìŠ¤í„´ìŠ¤ê°€ ê°€ì§„ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•  ìˆ˜ë„ ìˆë‹¤.

**ì›ë˜ëŠ” ìƒì„±ìì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ ì¡´ì¬í•˜ì§ˆ ì•Šì•˜ì–´ì•¼ í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ì¸ë°, Finalizer ë•Œë¬¸ì— ì‚´ì•„ ë‚¨ì•„ ìˆëŠ” ê²ƒì´ë‹¤.**

â†’ Final í´ë˜ìŠ¤ëŠ” ìƒì†ì´ ì•ˆë˜ë‹ˆê¹Œ ê·¼ë³¸ì ìœ¼ë¡œ ì´ëŸ° ê³µê²©ì´ ë§‰í˜€ ìˆìœ¼ë©°, ë‹¤ë¥¸ í´ë˜ìŠ¤ëŠ” `finalize()` ë©”ì†Œë“œì— `final` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ì„œ ìƒì†í•´ì„œ ì˜¤ë²„ë¼ì´ë”© í•˜ëŠ” ê²ƒì„ ë§‰ì„ ìˆ˜ ìˆë‹¤.

## Finalizerì™€ Cleanerë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìì› ë°˜ë‚© í•˜ëŠ” ë°©ë²•

ìì› ë°˜ë‚©ì´ í•„ìš”í•œ í´ë˜ìŠ¤ `AutoCloseable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³  `try-with-resource`ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, í´ë¼ì´ì–¸íŠ¸ê°€ `close` ë©”ì†Œë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ê²Œ ì •ì„ì´ë‹¤. ì—¬ê¸°ì„œ ì¶”ê°€ë¡œ ì–¸ê¸‰í•˜ìë©´, `close` ë©”ì†Œë“œëŠ” í˜„ì¬ ì¸ìŠ¤í„´ìŠ¤ì˜ ìƒíƒœê°€ ì´ë¯¸ ì¢…ë£Œëœ ìƒíƒœì¸ì§€ í™•ì¸í•˜ê³ , ì´ë¯¸ ë°˜ë‚©ì´ ëë‚œ ìƒíƒœì—ì„œ `close`ê°€ ë‹¤ì‹œ í˜¸ì¶œëë‹¤ë©´ `IllegalStateException`ì„ ë˜ì ¸ì•¼ í•œë‹¤.

ê·¸ëŸ¼ ëŒ€ì²´ ì™œ ë§Œë“¤ì—ˆì„ê¹Œ?

## 01 Finalizerì™€ Cleanerë¥¼ ì•ˆì „ë§ìœ¼ë¡œ ì“°ê¸°

ìì› ë°˜ë‚©ì— ì“¸ `close` ë©”ì†Œë“œë¥¼ í´ë¼ì´ì–¸íŠ¸ê°€ í˜¸ì¶œí•˜ì§€ ì•Šì•˜ë‹¤ëŠ” ê°€ì •í•˜ì—, ë¬¼ë¡  ì‹¤ì œë¡œ Finalizerë‚˜ Cleanerê°€ í˜¸ì¶œë ì§€ ì•ˆë ì§€ ì–¸ì œ í˜¸ì¶œë ì§€ë„ ëª¨ë¥´ê¸´ í•˜ì§€ë§Œ, ì•ˆí•˜ëŠ” ê²ƒ ë³´ë‹¤ëŠ” ë‚˜ìœ¼ë‹ˆê¹Œ. ì‹¤ì œë¡œ ìë°”ì—ì„œ ì œê³µí•˜ëŠ” `FileInputStream`, `FileOutputStream`, `ThreadPoolExecutor` ê·¸ë¦¬ê³  `java.sql.Connection`ì—ëŠ” ì•ˆì „ë§ìœ¼ë¡œ ë™ì‘í•˜ëŠ” finalizerê°€ ìˆë‹¤.

## 02 ë„¤ì´í‹°ë¸Œ í”¼ì–´ ì •ë¦¬í•  ë•Œ ì“°ê¸°

```
ìë°” í´ë˜ìŠ¤ -> ë„¤ì´í‹°ë¸Œ ë©”ì†Œë“œ í˜¸ì¶œ -> ë„¤ì´í‹°ë¸Œ ê°ì²´ (ë„¤í‹°ì´ë¸Œ Peer)

```

ë„¤ì´í‹°ë¸Œ ê°ì²´ëŠ” ì¼ë°˜ì ì¸ ê°ì²´ê°€ ì•„ë‹ˆë¼ì„œ GCê°€ ê·¸ ì¡´ì¬ë¥¼ ëª¨ë¥¸ë‹¤. ë„¤ì´í‹°ë¸Œ í”¼ì–´ê°€ ë“¤ê³  ìˆëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì¤‘ìš”í•˜ì§€ ì•Šì€ ìì›ì´ë©°, ì„±ëŠ¥ìƒ ì˜í–¥ì´ í¬ì§€ ì•Šë‹¤ë©´ Cleanerë‚˜ Finalizerë¥¼ ì‚¬ìš©í•´ì„œ í•´ë‹¹ ìì›ì„ ë°˜ë‚©í•  ìˆ˜ë„ ìˆì„ ê²ƒì´ë‹¤. í•˜ì§€ë§Œ, ì¤‘ìš”í•œ ë¦¬ì†ŒìŠ¤ì¸ ê²½ìš°ì—ëŠ” ìœ„ì—ì„œ ì–¸ê¸‰í•œëŒ€ë¡œ `close` ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ëŠ”ê²Œ ì¢‹ë‹¤.

## Cleaner ì˜ˆì œ ì½”ë“œ

```java
public class CleanerSample implements AutoCloseable {

    private static final Cleaner CLEANER = Cleaner.create();

    private final CleanerRunner cleanerRunner;

    private final Cleaner.Cleanable cleanable;

    public CleanerSample() {
        cleanerRunner = new CleanerRunner();
        cleanable = CLEANER.register(this, cleanerRunner);
    }

    @Override
    public void close() {
        cleanable.clean();
    }

    public void doSomething() {

        System.out.println("do it");
    }

    private static class CleanerRunner implements Runnable {

        // TODO ì—¬ê¸°ì— ì •ë¦¬í•  ë¦¬ì†ŒìŠ¤ ì „ë‹¬

        @Override
        public void run() {
            // ì—¬ê¸°ì„œ ì •ë¦¬
            System.out.printf("close");
        }
    }

}

```

ì£¼ì˜ í•  ì 

- Cleaner ì“°ë ˆë“œ(`CleanerRunner`)ëŠ” ì •ë¦¬í•  ëŒ€ìƒì¸ ì¸ìŠ¤í„´ìŠ¤ (`CleanerSample`)ì„ ì°¸ì¡°í•˜ë©´ ì•ˆëœë‹¤. ìˆœí™˜ ì°¸ì¡°ê°€ ìƒê²¨ì„œ GC ëŒ€ìƒì´ ë˜ì§ˆ ëª»í•œë‹¤.
- Cleaner ì“°ë ˆë“œë¥¼ ë§Œë“¤ í´ë˜ìŠ¤ëŠ” ë°˜ë“œì‹œ static í´ë˜ìŠ¤ì—¬ì•¼ í•œë‹¤. non-static í´ë˜ìŠ¤(ìµëª… í´ë˜ìŠ¤ë„ ë§ˆì°¬ê°€ì§€)ì˜ ì¸ìŠ¤í„´ìŠ¤ëŠ” ê·¸ê±¸ ê°ì‹¸ê³  ìˆëŠ” í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¸ì¡°í•˜ì§€ ì•ŠëŠ”ë‹¤.

<aside>
ğŸ’¡ cleaner, finalizerëŠ” ì•ˆì „ë§ ì—­í• ì´ë‚˜ ì¤‘ìš”í•˜ì§€ ì•Šì€ ë„¤ì´í‹°ë¸Œ ìì› íšŒìˆ˜ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì!

</aside>

## ì°¸ê³ 

- [AutoCloseable](https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html)
- [Try-With-Resource](https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html)
- [Cleaner](https://docs.oracle.com/javase/9/docs/api/java/lang/ref/Cleaner.html)
- [Cleaner ì˜ˆì œ](https://www.logicbig.com/tutorials/core-java-tutorial/gc/ref-cleaner.html)
